<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="description" content="Download videos from any website with our advanced video downloader. Supports YouTube, Vimeo, Twitter, Instagram, TikTok and more.">
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
    </button>

    <div class="container">
        <header>
            <h1><i class="fas fa-download"></i> Video Downloader Pro</h1>
            <p>Download videos from any website with advanced quality options</p>
        </header>

        <main>
            <div class="download-form">
                <div class="form-group">
                    <label for="videoUrl">
                        <i class="fas fa-link"></i> Video URL
                    </label>
                    <div class="input-group">
                        <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." required>
                        <button type="button" id="getInfoBtn" class="btn btn-secondary">
                            <i class="fas fa-search"></i> Analyze
                        </button>
                    </div>
                    <small class="help-text">
                        <i class="fas fa-info-circle"></i> 
                        Supports 1000+ sites: YouTube, Vimeo, Twitter, Instagram, TikTok, Facebook, Twitch, and more.
                    </small>
                </div>

                <div id="videoInfo" class="video-info hidden">
                    <div class="video-preview">
                        <img id="thumbnail" src="" alt="Video thumbnail" class="thumbnail">
                        <div class="video-details">
                            <h3 id="videoTitle"></h3>
                            <p id="videoDescription"></p>
                            <div class="meta-info" id="metaInfo"></div>
                        </div>
                    </div>

                    <div class="format-selection">
                        <h4><i class="fas fa-cog"></i> Select Quality</h4>
                        <div id="formatGrid" class="format-grid"></div>
                    </div>

                    <div class="form-group">
                        <label for="filename">
                            <i class="fas fa-file"></i> Custom Filename (optional)
                        </label>
                        <input type="text" id="filename" placeholder="Leave empty for automatic naming" class="form-control">
                        <small class="help-text">
                            <i class="fas fa-lightbulb"></i> 
                            Use %(title)s for video title, %(uploader)s for channel name
                        </small>
                    </div>

                    <button type="button" id="downloadBtn" class="btn btn-primary">
                        <i class="fas fa-download"></i> Download Video
                    </button>
                </div>

                <div id="downloadProgress" class="download-progress hidden">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <p id="progressText">Starting download...</p>
                </div>

                <div id="message" class="message hidden"></div>
            </div>

            <div class="downloads-section">
                <h2><i class="fas fa-folder-open"></i> Downloaded Files</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="refreshDownloads" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="clearDownloads" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
                <div id="downloadsList" class="downloads-list"></div>
            </div>
        </main>
    </div>

    <script>
        let currentVideoInfo = null;
        let downloadInterval = null;
        let selectedFormat = 'best';

        // DOM elements
        const videoUrlInput = document.getElementById('videoUrl');
        const getInfoBtn = document.getElementById('getInfoBtn');
        const videoInfoDiv = document.getElementById('videoInfo');
        const formatGrid = document.getElementById('formatGrid');
        const filenameInput = document.getElementById('filename');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadProgress = document.getElementById('downloadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const messageDiv = document.getElementById('message');
        const downloadsList = document.getElementById('downloadsList');
        const refreshBtn = document.getElementById('refreshDownloads');
        const clearBtn = document.getElementById('clearDownloads');
        const darkModeToggle = document.getElementById('darkModeToggle');

        // Event listeners
        getInfoBtn.addEventListener('click', getVideoInfo);
        downloadBtn.addEventListener('click', downloadVideo);
        refreshBtn.addEventListener('click', loadDownloads);
        clearBtn.addEventListener('click', clearDownloads);
        darkModeToggle.addEventListener('click', toggleDarkMode);

        // Load downloads on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDownloads();
            initializeDarkMode();
        });

        // Enter key support
        videoUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                getVideoInfo();
            }
        });

        async function getVideoInfo() {
            const url = videoUrlInput.value.trim();
            if (!url) {
                showMessage('Please enter a video URL', 'error');
                videoUrlInput.focus();
                return;
            }

            if (!isValidUrl(url)) {
                showMessage('Please enter a valid URL', 'error');
                videoUrlInput.focus();
                return;
            }

            getInfoBtn.disabled = true;
            getInfoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';

            try {
                const response = await fetch('/get_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();

                if (data.success) {
                    currentVideoInfo = data.info;
                    displayVideoInfo(data.info);
                    showMessage('Video information loaded successfully!', 'success');
                } else {
                    showMessage(data.error || 'Failed to get video information', 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            } finally {
                getInfoBtn.disabled = false;
                getInfoBtn.innerHTML = '<i class="fas fa-search"></i> Analyze';
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function displayVideoInfo(info) {
            // Update video details
            document.getElementById('videoTitle').textContent = info.title;
            document.getElementById('videoDescription').textContent = info.description || 'No description available';
            
            const metaInfo = document.getElementById('metaInfo');
            metaInfo.innerHTML = `
                <div class="meta-item">
                    <i class="fas fa-user"></i>
                    <span>${info.uploader || 'Unknown'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span>${formatDuration(info.duration)}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-eye"></i>
                    <span>${formatNumber(info.view_count)} views</span>
                </div>
            `;
            
            if (info.thumbnail) {
                document.getElementById('thumbnail').src = info.thumbnail;
            }

            // Update format options
            displayFormatOptions(info.formats || []);

            // Show video info section
            videoInfoDiv.classList.remove('hidden');
        }

        function displayFormatOptions(formats) {
            formatGrid.innerHTML = '';

            if (formats.length === 0) {
                const fallbackOption = document.createElement('div');
                fallbackOption.className = 'format-option selected';
                fallbackOption.innerHTML = `
                    <div class="format-name">Best Available</div>
                    <div class="format-details">Auto-select best quality</div>
                `;
                fallbackOption.onclick = () => selectFormat('best', fallbackOption);
                formatGrid.appendChild(fallbackOption);
                selectedFormat = 'best';
                return;
            }

            // Add "Best Quality" option first
            const bestOption = document.createElement('div');
            bestOption.className = 'format-option selected';
            bestOption.innerHTML = `
                <div class="format-name">Best Quality</div>
                <div class="format-details">Recommended</div>
            `;
            bestOption.onclick = () => selectFormat('best', bestOption);
            formatGrid.appendChild(bestOption);

            // Add specific format options
            formats.slice(0, 12).forEach(format => {
                const formatOption = document.createElement('div');
                formatOption.className = 'format-option';
                
                const audioIcon = format.has_audio ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
                const qualityBadge = getQualityBadge(format.height);
                
                formatOption.innerHTML = `
                    <div class="format-name">
                        ${format.resolution || 'Unknown'} ${qualityBadge}
                    </div>
                    <div class="format-details">
                        ${format.extension.toUpperCase()} • ${format.file_size} ${audioIcon}
                    </div>
                `;
                
                formatOption.onclick = () => selectFormat(format.format_id, formatOption);
                formatGrid.appendChild(formatOption);
            });

            selectedFormat = 'best';
        }

        function getQualityBadge(height) {
            if (height >= 2160) return '<span class="status-indicator info">4K</span>';
            if (height >= 1440) return '<span class="status-indicator success">HD+</span>';
            if (height >= 1080) return '<span class="status-indicator success">HD</span>';
            if (height >= 720) return '<span class="status-indicator warning">HD</span>';
            if (height >= 480) return '<span class="status-indicator warning">SD</span>';
            return '<span class="status-indicator error">Low</span>';
        }

        function selectFormat(formatId, element) {
            // Remove selected class from all options
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            selectedFormat = formatId;
        }

        async function downloadVideo() {
            if (!currentVideoInfo) {
                showMessage('Please analyze video information first', 'error');
                return;
            }

            const url = videoUrlInput.value.trim();
            const filename = filenameInput.value.trim();

            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        url: url, 
                        format: selectedFormat,
                        filename: filename || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Download started successfully!', 'success');
                    downloadProgress.classList.remove('hidden');
                    startProgressTracking();
                } else {
                    showMessage(data.error || 'Failed to start download', 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Video';
            }
        }

        function startProgressTracking() {
            downloadInterval = setInterval(async () => {
                try {
                    const response = await fetch('/status');
                    const status = await response.json();

                    progressFill.style.width = status.progress + '%';
                    progressText.textContent = status.status;

                    if (!status.in_progress) {
                        clearInterval(downloadInterval);
                        downloadInterval = null;

                        if (status.error) {
                            showMessage('Download failed: ' + status.error, 'error');
                        } else {
                            showMessage('Download completed successfully!', 'success');
                            loadDownloads(); // Refresh downloads list
                        }

                        // Hide progress after 5 seconds
                        setTimeout(() => {
                            downloadProgress.classList.add('hidden');
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Error checking download status:', error);
                }
            }, 1000);
        }

        async function loadDownloads() {
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const response = await fetch('/downloads');
                const data = await response.json();

                if (data.files) {
                    displayDownloads(data.files);
                } else if (data.error) {
                    showMessage('Error loading downloads: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Network error loading downloads: ' + error.message, 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }
        }

        function displayDownloads(files) {
            if (files.length === 0) {
                downloadsList.innerHTML = `
                    <div class="no-files">
                        <i class="fas fa-folder-open"></i>
                        <p>No downloaded files yet.</p>
                        <p>Start by analyzing and downloading a video!</p>
                    </div>
                `;
                return;
            }

            const html = files.map(file => `
                <div class="download-item">
                    <div class="file-info">
                        <i class="fas fa-file-video"></i>
                        <span class="filename">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    </div>
                    <div class="file-date">${formatDate(file.modified)}</div>
                </div>
            `).join('');

            downloadsList.innerHTML = html;
        }

        async function clearDownloads() {
            if (!confirm('Are you sure you want to clear all downloaded files? This action cannot be undone.')) {
                return;
            }

            try {
                // This would need to be implemented in the backend
                showMessage('Clear downloads feature coming soon!', 'warning');
            } catch (error) {
                showMessage('Error clearing downloads: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            messageDiv.innerHTML = `<i class="fas fa-${getMessageIcon(type)}"></i> ${text}`;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');

            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 6000);
        }

        function getMessageIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return 'Unknown';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function formatNumber(num) {
            if (!num) return 'Unknown';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            
            return date.toLocaleDateString();
        }

        // Dark mode functionality
        function initializeDarkMode() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        // Auto-refresh downloads every 30 seconds
        setInterval(loadDownloads, 30000);

        // Add some nice animations
        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease-in-out';
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html>